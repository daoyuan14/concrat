CFLAGS = -pthread

all:
	make main.rs a.xml

main: a.o b.o
	$(CC) $(CFLAGS) -o $@ $^

main.c: a.c
	CC="cilly --gcc=/usr/bin/gcc --merge --keepmerged --noPrintLn" make main && \
	mv main_comb.c main.c

a.xml: main.c
	goblint --conf ../../conf.json \
		--enable allglobs \
		--set result fast_xml \
		--set outfile a.xml \
		main.c

mainrs: main.o
	$(CC) $(CFLAGS) -o $@ $^

compile_commands.json: main.c
	intercept-build make mainrs

main.rs: compile_commands.json
	c2rust transpile -e compile_commands.json

clean:
	rm -rf main mainrs main.c *.o *.xml *.json *.rs Cargo.* rust-toolchain target

clean-intermediate:
	rm -rf main mainrs *.o *.json Cargo.lock target
